\chapter{Gaia and the hydras (draft)}
\index{coq}{Plug-ins!Gaia}
\label{gaia-chapter}

\section{Introduction}
The \gaia project~\cite{Gaia} by Jos\'e Grimm aimed to formalize mathematics in \coq  in
the style of Nicolas Bourbaki. The formalization of the first book in the
Elements of Mathematics series by Bourbaki, on the theory of sets, was
initially described in a technical report in July 2009~\cite{Grimm2009a}.
The set-theoretic axioms and basic definitions in \gaia were derived
from an earlier development by Carlos Simpson~\cite{Simpson2004,CatsZFCContrib}.
Grimm then wrote (and continually updated) technical reports describing the
formalization of Bourbaki's two subsequent books~\cite{Grimm2009b,Grimm2016}
and additional topics in number theory~\cite{grimm:hal-00911710,Grimm2014},
before he passed away in 2019.

In 2020, members of \community transferred the \gaia source code to
GitHub and adapted it for recent releases of the Mathematical Components
library, which \gaia heavily relies on.
Anonymous volunteers (``collaborators of Nicolas Bourbaki'') then finished
the only in-progress proof left by Grimm. At around 155,000 LOC, \gaia is currently one of the largest maintained open source \coq projects.

\gaia contains definitions of ordinals in Cantor and Veblen normal form~\cite{grimm:hal-00911710}, adapted from the historical Cantor contribution~\cite{CantorContrib}. The data types for ordinals are essentially defined the same way as in \Hydras, but they are not identical inside \coq, e.g., due to residing in different modules. There are also minor differences in how ordinal arithmetic is implemented, due to the different evolutionary paths taken since divergence from the ancestor library.



The bridge we aim to build and cross is a two-way bridge:

\begin{itemize}
\item \gaia contains lemmas on ordinal arithmetic (\emph{e.g.} associativity of multiplication of ordinals strictly less than $\epsilon_0$), which were missing from \Hydras. 
  \item The other way, \Hydras contains formal definitions and proofs of properties of canonical sequences and rapidly growing functions  (see Chapters~\ref{chap:ketonen} and~\ref{chap:alpha-large}~of this book).
  \end{itemize}
  
  We plan to make accessible the first kind of lemmas to \HydrasLib' users and the second kind to \gaia's. For this purpose, we write modules dedicated to the importation of definitions and lemmas from each of both libraries into the other one.
  Please note that by ``import'' we do not mean ``duplicate''
  nor ``repairing'' \HydrasLib' proofs.  Whenever possible, we proceed by rewriting steps over the statements and not the proofs. In a future version, it would be nice to have our proofs in the same context, after porting \HydrasLib' proofs under \gaia's
  definition, following  proof repair  techniques~\cite{ringer2021}.



This initial draft bridge code mostly uses the SSReflect proof language
and idioms from the Mathematical Components library. We made this design
decision since we believe it is less challenging to reason about
Hydra-battles code using SSReflect and MathComp than to reason about
Gaia without SSReflect\footnote{The author of these proof scripts is still a beginner in Ssreflect. Please forgive the clumsiness of the current proof scripts.}.

\section{Library structure}
The \gaiaHydras library is designed for users of
\gaia and/or  \HydrasLib. Whenever possible, we managed to respect the notations and naming conventions of both libraries.

The modules are located in {\texttt{theories/gaia/*.v}}.
The main entry point is
\href{../theories/html/gaia_hydras.T1Bridge.html}{gaia\_hydras.T1Bridge}, which requires both Gaia's \texttt{ssete9} and a few modules of \texttt{theories/ordinals/Epsilon0}.
Other modules are dedicated to the adaptation of several notions of \HydrasLib to \mathcomp's and \gaia's vocabulary and structures.
By default, we give priority to \gaia's notation and vocabulary.


\subsection{The \texttt{T1Bridge} Module}

\texttt{T1Bridge} starts with a few requirements.
\inputsnippets{T1Bridge/Requirements}

Because of the common origin of \HydrasLib and \gaia, both libraries share the common name \texttt{T1} (data type of ordinal terms below $\epsilon_0$). As mentionned before, the bare name \texttt{T1} is given by priority to \gaia, and we prefix this name with an \texttt{h} (for ``hydras'') to refer to
\href{../theories/html/Epsilon0.T1.html}{hydras.Epsilon0.T1.T1}.

\inputsnippets{T1Bridge/hT1gT1}

Many constants are common to \HydrasLib and \gaia. The following notations allow us to get rid of possible ambiguities, still
keeping with the prefix convention: ``h'' for \HydrasLib, ``g'' for \gaia. 

\inputsnippets{T1Bridge/MoreNotations}

Please keep in mind that, in this module, we favour \gaia's notations over hydra's. A snippet like \texttt{(alpha < succ beta)} should be interpreted as \texttt{(T1lt alpha beta)}, where \texttt{T1lt} is defined in ~\href{https://github.com/coq-community/gaia/blob/master/theories/ssete9.v}{\texttt{gaia.ssete9.v}}.


\subsection{Translation functions and data refinement}

The bridge between both libraries is made of two straightforward bijections.

\inputsnippets{T1Bridge/h2gG2hDef}
\inputsnippets{HydraGaia_Examples/ExamplesG2H}

\subsubsection{Pretty printing Cantor normal forms}
\label{sect:gaia-ppT1}

The function \texttt{g2h} is also used to provide a ``pretty'' printing of Cantor normal forms (please see Sect.~\vref{sect:ppT1}).

\inputsnippets{T1Bridge/T1ppDef}

\inputsnippets{HydraGaia_Examples/T1pp}

\subsubsection{Cancel lemmas}

The following cancel lemmas will be often applied in order to simplify sub-terms of the form (\texttt{g2h (h2g {\it t})}) and (\texttt{h2g (g2h {\it t})}), which appear in many proofs by rewriting.

\inputsnippets{T1Bridge/h2gG2hRw, T1Bridge/g2hH2gRw}

\inputsnippets{T1Bridge/h2gEqIff, T1Bridge/g2hEqIff}


\subsubsection{Refinements: Definitions}


Functions \texttt{h2g} and \texttt{g2h} allow us to define
a notion of ``data-refinement''  for constants, functions, predicates and relations. The following definitions express that some
constant, function, relation defined in \HydrasLib ``implements'' the same concept of \gaia.








\inputsnippets{T1Bridge/refineDefs}

Refinement lemmas can be easily ``reversed''.

\inputsnippets{T1Bridge/refines1R, T1Bridge/refines2R}

\subsection{Examples of refinement}
Both of our libraries define constants like $0$, $1$, $\omega$, and arithmetic functions: successor, addition, multiplication, and exponential of base $\omega$ (function $\phi_0$). We prove that these definitions are mutually consistent. Finally, we prove that the boolean predicates `` to be in normal form'' are equivalent.

\subsubsection{A few constants}
For each constant: $0$, $1$, \dots, $n$ and $\omega$, we prove
that \texttt{hydras}' definition refines \texttt{gaia}'s.
\inputsnippets{T1Bridge/constantRefs}

%\inputsnippets{T1Bridge/utf8try}

\subsubsection{Unary functions}

\inputsnippets{T1Bridge/unaryRefs}

\subsubsection{Order and comparison}
\label{sect:lt-compat-gaia}
Leibniz equality and strict order on both libraries are
compatible:


\inputsnippets{T1Bridge/eqRef}

\label{sect:gaia-compare-ref}
\inputsnippets{T1Bridge/compareRef}

\inputsnippets{T1Bridge/ltRef, T1Bridge/leRef}

\inputsnippets{T1Bridge/decideHLtRw}

\subsubsection{More rewriting lemmas}

\inputsnippets{T1Bridge/T1ltIff}
\inputsnippets{T1Bridge/T1leIff}

\inputsnippets{T1Bridge/rewritingRules}

\inputsnippets{T1Bridge/limitbRef, T1Bridge/isSuccRef}


\subsubsection{Addition and multiplication}
\label{sect:plus-mult-gaia-hydras}

The binary operations $+$ and $\times$ are defined the same way in both libraries. Please note that they require comparison of ordinal terms. So, the proof of the following lemmas applies
compatibility lemmas like \texttt{compare\_ref} (see Section~\vref{sect:gaia-compare-ref}).

\inputsnippets{T1Bridge/plusRef, T1Bridge/multRef}



\subsubsection{Cantor normal form}
\label{nf-gaia-compat}
Both definitions of ``being in Cantor normal form'' are
compatible.

\inputsnippets{T1Bridge/nfRef}



\subsection{Looking for a lemma}
\coq's command \texttt{Search} and notation scopes allow you to explore both libraries.
For instance, let us look for lemmas whose conclusion is
$\alpha \times \beta=\beta$.

\inputsnippets{T1Bridge/SearchDemo}


\subsection{A type for well-formed ordinal terms}

For sake of compatibility, we add a clone of \texttt{hydra-battles}' type \texttt{E0} defined in \href{../theories/html/hydras.Epsilon0.E0.html}{Epsilon0.E0}.

\inputsnippets{T1Bridge/E0Def}
\inputsnippets{T1Bridge/E0plusMultDef}


\inputsnippets{T1Bridge/E0EqP}

In order to import definitions and lemmas
from~\href{../theories/html/hydras.Epsilon0.E0.html}{Epsilon0.E0}, we define a pair of translations.

\inputsnippets{T1Bridge/gE0h2gG2h}

These tools allow us, for instance,  to import \texttt{E0.lt}'s  well-foundedness.

\inputsnippets{T1Bridge/gE0LtWf}

\section{E0 as an ordinal notation}
The module \href{../theories/html/gaia_hydras.T1Bridge.html}{gaia\_hydras.T1Bridge} defines an instance of class \texttt{ON E0lt compare}
(see Chapter~\ref{chap:ON}).

\inputsnippets{T1Bridge/T1compareDef}
\inputsnippets{ T1Bridge/T1compareCorrect}
\inputsnippets{T1Bridge/E0compare}
\inputsnippets{T1Bridge/E0Sto}
\inputsnippets{T1Bridge/gEpsilon0}

\inputsnippets{T1Bridge/ExampleComp}





\section{Importing Definitions and theorems from \HydrasLib}

Some constructions of \HydrasLib were (to our knowledge) not implemented in \gaia yet. For instance, commutative (``Hessenberg'') addition, canonical sequences and Ketonen-Solovay machinery (Chapters~\ref{chap:T1}, \ref{chap:ketonen} and \ref{chap:alpha-large}). In order not to copy long proofs, we chose to
\emph{derive} several constructions from \HydrasLib into \gaia's world, and rewrite \HydrasLib statements in order to make them \gaia-compatible.


\subsubsection{Remark}
\label{sect:gaia-masking}
We try to respect the following ``protocol''.
Let us assume we adapt some definitions and properties
from a given module \texttt{hydras.Epsilon0.Foo}, and a constant \texttt{bar} of this module, whose absolute name is
thus \texttt{hydras.Epsilon0.Foo.bar}.
\begin{enumerate}
\item We create a module \texttt{gaia\_hydras.GFoo}
  (``G'' for \gaia).
\item Inside \texttt{GFoo}, the identifier \texttt{bar}
  is reserved in priority to \gaia's version, and the notation
  \texttt{hbar} is used for \texttt{hydras.Epsilon0.Foo.bar}.
\end{enumerate}

 


\subsection{Hessenberg sum}

Natural sum  (a.k.a. Hessenberg's  sum) is defined in
\href{../theories/html/hydras.Epsilon0.Hessenberg.html}{hydras.Epsilon0.Hessenberg} and is used for proving termination of all hydra battles (See Sect.~\ref{sect:hessenberg-def}).

We define this function by delegation to \HydrasLib'.
\vspace{4pt} 
\noindent.

From\href{../theories/html/gaia\_hydras.GHessenberg.html}{gaia\_hydras.GHessenberg}

\inputsnippets{GHessenberg/oplusDef}

By simple rewriting, we import the following lemmas.


\inputsnippets{GHessenberg/oplusEquations}

Hessenberg sum is associative, commutative and strictly monotonous (on ordinal terms in normal form).

\inputsnippets{GHessenberg/oplusLemmasa}
\inputsnippets{GHessenberg/oplusLemmasb}
\inputsnippets{GHessenberg/oplusLemmasc}
\inputsnippets{GHessenberg/oplusLemmasd}
\inputsnippets{GHessenberg/oplusLemmase}






\subsection{Canonical sequences}
Canonical sequences are described in Chapter~\vref{chap:ketonen}, and implemented in
\href{../theories/html/hydras.Epsilon0.Canon.html}%
{\texttt{hydras.Epsilon0.Canon}}.
Module~\href{../theories/html/gaia_hydras.GCanon.html}%
{\texttt{gaia\_hydras.GCanon}}, imports definitions and results from that library.



First, we rename \HydrasLib' \texttt{canon} function into
\texttt{hcanon}. Then we define a new function \emph{via} the
translations \texttt{g2h} and \texttt{h2g}.

\inputsnippets{GCanon/canonDef}


\inputsnippets{GCanon/g2hCanonRw}

The following lemmas are proved by rewriting from corresponding statements proved in \HydrasLib. The first six lemmas correspond to rewriting rules derived from the body of the definition of \texttt{Epsilon0.Canon.canon}.




\inputsnippets{GCanon/gcanonZero}
\inputsnippets{GCanon/gcanonSucc}
\inputsnippets{GCanon/gcanonSSn}
\inputsnippets{GCanon/gcanonLim1}
\inputsnippets{GCanon/gcanonLim2}
\inputsnippets{GCanon/gcanonLim3}



\inputsnippets{GCanon/gcanonLt}
\inputsnippets{GCanon/glimitCanonSNotZero}
\inputsnippets{GCanon/gcanonLimitMono}
\inputsnippets{GCanon/glimitCanonSNotZero}

\subsubsection{Canonical sequences and limits}


Let us recall \gaia's definition of $\omega$-limit.

\inputsnippets{nfwfgaia/LimitV2Def, nfwfgaia/LimitOFDef}

We adapt theorems from \href{../theories/html/hydras.Epsilon0.Canon.html}%
{\texttt{hydras.Epsilon0.Canon}} to \gaia's vocabulary.

\inputsnippets{GCanon/gcanonLimitStrong}
\inputsnippets{GCanon/gcanonLimitV2}
\inputsnippets{GCanon/gcanonLimitOf}

\subsection{Accessibility in \texorpdfstring{$\epsilon_0$}{epsilon\_0}}

The library \href{../theories/html/gaia_hydras.GPaths.html}%
{\texttt{gaia\_hydras.GPaths}} imports definitions and lemmas from
\href{../theories/html/hydras.Epsilon0.Paths.html}%
{\texttt{hydras.Epsilon0.Paths}}.

Please refer to Sect.~\ref{sect:pathes-intro} for a descrition of that library.


\subsubsection{Transitions}
  
\inputsnippets{GPaths/importationsa}

\subsubsection{Paths}

\inputsnippets{GPaths/pathsDefs}

\subsubsection{Main theorems about paths}

If $\beta$ is (strictly) accessible from $\alpha$, then
$\beta<\alpha$.

\inputsnippets{GPaths/pathToLT}

Constant index paths can be simulated with constant paths with larger index.

\inputsnippets{GPaths/Cor12}


If $\beta<\alpha$, then $\beta$ is accessible from $\alpha$
through some constant-index path.

\inputsnippets{GPaths/Lemma261}

Any constant-index path can be simulated by a ``standard'' path (with index incremented by 1 at each step).

\inputsnippets{GPaths/constantToStandard}

As a corollary, we relate ordinal inequality to standard paths.

\inputsnippets{GPaths/LTToStandard}

\subsection{A family of rapidly growing functions}

The functions $F_\alpha$ are described in Section~\vref{sect:wainer}. The symbol \texttt{F\_} has type \texttt{E0 -> nat -> nat},
where \texttt{E0} is the type of well formed ordinal terms less than $\epsilon_0$.

\subsubsection{Importing the \texttt{F\_alpha} family}

We are now able to import \HydrasLib' $F_\alpha$ functions.

\inputsnippets{GF_alpha/FAlphaDef}

\begin{todo}
  Give equations for \texttt{F\_} (corresponding to the equation
  in \HydrasLib.
\end{todo}




The following definitions adapt \HydrasLib' to \ssreflect's 
definitions of $<$ and $\leq$ on \texttt{nat}.

\inputsnippets{T1Bridge/MonoDef}

By rewriting, we import a few lemmas from
~\href{../theories/html/hydras.Epsilon0.F_alpha.html}{Epsilon0.F\_alpha}.



\inputsnippets{GF_alpha/FAlphaProps}

With the same technique, we prove that if
$\alpha\geq\omega$, then $F_\alpha$ is not primitive recursive.

\inputsnippets{GF_alpha/FAlphaNotPR}



\section{Importing a theorem from \gaia}
\label{sect:gaia2hydra}

The \texttt{Gaia} library already contains many lemmas about
ordinal arithmetic. In this section, we give two examples of
porting such a lemma to \HydrasLib' vocabulary.

\subsection{Associativity of ordinal multiplication (below \texorpdfstring{$\epsilon_0$}{epsilon\_0})}
\gaia already contains a proof that the multiplication of ordinals less than $\epsilon_0$ is associative.
\emph{From~\href{https://github.com/coq-community/gaia/blob/master/theories/ssete9.v}{gaia.ssete9.v}}

\begin{Coqsrc}
Lemma mulA: associative T1mul.
\end{Coqsrc}

This lemma was missing from \texttt{hydra-battles}. Nevertheless, we could adapt this lemma to \texttt{hydra-battles}' ordinals, by a small sequence of rewritings.

\inputsnippets{T1Bridge/multA}

The module~\href{../theories/html/gaia_hydras.GaiaToHydra.html}%
{\texttt{gaia\_hydras.GaiaToHydra}} shows a small
example of importation of \texttt{multA} into \texttt{hydra-battles}' world.

\inputsnippets{GaiaToHydra/T1BridgeUse}

In the rest of this module, names like  \texttt{T1}, \texttt{omega}, etc. are  bound to \HydrasLib' meaning.

 \inputsnippets{GaiaToHydra/LocateT1, GaiaToHydra/T1BridgeUseb}

 \subsection{Right Distributivity, etc.}
 Likewise, we prove almost for free that ordinal multiplication is right distributive over addition (with \HydrasLib' definitions).

 \inputsnippets{GaiaToHydra/distributivity}

We plan to automatize as soon as possible this kind of transfer of lemmas from \gaia to \HydrasLib.





% \section{Gaia's proof of well-foundedness}
% The library \HydrasLib already contains two proofs
% of well-foundedness of the strict order on ordinal terms in
% Cantor normal form: a direct proof~\vref{sec:T1Wf} and a proof based on the recursive path ordering~\vref{remark:a3pat}, by
% \'Evelyne Contejean. We found it interesting to comment Gaia's proof, which uses tools already present in~\cite{CantorContrib}.



% This proof is quite dense and qualified as ``a bit tricky''. We just present here its main steps with the help of the \alectr tool.

% The reader is invited to replay the full proof in  \href{https://github.com/coq-community/gaia/blob/master/theories/ssete9.v}{gaia.ssete9.v}, and to compare with
% the proof in Section~\ref{sec:strongly-accessible}.

% \begin{remark}
%   The following snippets have been generated, not from
%   \href{https://github.com/coq-community/gaia/blob/master/theories/ssete9.v}{gaia.ssete9.v}, but on a provisional copy:
% \url{../theories/gaia/nfgaia.v} we made in order to insert comments for \alectr.  This copy is planned to be removed when we are able to add \alectr directives to a \coq source we are not allowed to modify.
% \end{remark}

% \subsection{Restricted recursion}
% As remarked in~\vref{sec:T1Wf}, the order \texttt{T1lt} on \texttt{T1} is not well-founded, because of terms not in normal form.
% But the \emph{restriction} of \texttt{T1lt} to terms in normal form \emph{is} well-founded. The following section introduces a  vocabulary in order to reason about statements of the form  ``the restriction of the relation $R$ to a subset $P$ of $A$ is well founded''.




% \inputsnippets{nfwfgaia/restrictedRecursion}

% The following induction principle is just a variant of \texttt{well\_founded\_induction\_type} for relations defined with \texttt{restrict}.

% \inputsnippets{nfwfgaia/restrictedRecursiona}

% With $P=\texttt{T1nf}$, this principle will allow us to write proofs by transfinite induction.

% \subsection{Main proof steps}

% \emph{Notes: the abbreviation \texttt{LT}, and the \texttt{fold LT} and \texttt{unfold LT} tactics,are not in \texttt{gaia}, but  have been added to make the goal display more readable.
% The infix notation \texttt{`` \_ < \_''}  is bound to the order \texttt{T1lt} in \gaia, while,  in \HydrasLib,  it is bound to its restriction \texttt{LT} to terms in normal form. }

% \inputsnippets{nfwfgaia/nfWfProofa}
% We start with a classic structural induction on the type \texttt{T1}.

% \inputsnippets{nfwfgaia/nfWfProofaa}
% The following \texttt{ssreflect} tactic  pushes a new hypothesis \texttt{Hb} which --- in the same terms as in Section~\vref{sec:strongly-accessible} --- tells that any ordinal less than $a$ is ``strongly accessible''.

% \inputsnippets{nfwfgaia/nfWfProofb}

% The following sentence gives us the possibility of induct over \texttt{a}'s accessibility.

% \inputsnippets{nfwfgaia/nfWfProofbb}


% By the following two forward steps, we show that $b$ is accessible, and will be able to prove properties by induction on $b$'s accessibility.

% \inputsnippets{nfwfgaia/haveHc}

% \inputsnippets{nfwfgaia/haveHd}

% \inputsnippets{nfwfgaia/hdProved}

% Now, let us consider any ordinal term which is (by \texttt{LT}) less than \texttt{(cons a n b)}.

% There are three cases to consider.
% \begin{enumerate}
% \item It is of the form \texttt{(cons a' n' b')} where \texttt{a'} is strictly less than \texttt{a}.
%   \inputsnippets{nfwfgaia/nfWfProofd}
  
%   Then, it is accessible (by hypothesis \texttt{Hb}).
  
%   \item The considered term  is equal to
%     \texttt{(cons a n b'')}, where $b''<\omega^a$. 
%     \inputsnippets{nfwfgaia/nfWfProofg}
    
%     Then we can replace \texttt{a''} with \texttt{a}, \texttt{n''} with \texttt{n}, and apply the hypotheses \texttt{Hd} and \texttt{He}.
    
% \item
%   The term is equal to
%   \texttt{(cons a n'' b'')}, where $n''<n$ and $b''<\omega^a$.

  
  
%   \inputsnippets{nfwfgaia/nfWfProofe}

%   By \texttt{Hd} and \texttt{He}, and a few technical lemmas about normal forms,   the term  \texttt{(cons a n b'')} is accessible, and so is \texttt{(cons a n'' b'')}.

 
% \end{enumerate}

% In every case, the considered ordinal is accessible. By the definition of accessibility, the ordinal \texttt{(cons a n b)} is accessible, which ends the proof. 


